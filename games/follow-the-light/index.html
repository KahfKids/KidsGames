<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Follow the Lights!</title>

  <!-- KidsGames PWA Support -->
  <link rel="manifest" href="/KidsGames/manifest.json" />
  <meta name="theme-color" content="#8b5cf6" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <link rel="apple-touch-icon" href="/KidsGames/icons/icon-192x192.png" />

  <!-- Google Fonts - Poppins for modern, clean look -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />

  <!-- Tone.js for sound -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }

    body {
      font-family: 'Poppins', sans-serif;
      height: 100dvh;
      width: 100vw;
      overflow: hidden;
      position: fixed;
      top: 0;
      left: 0;
      background: linear-gradient(135deg, #ff6b6b 0%, #feca57 25%, #48dbfb 50%, #ff9ff3 75%, #54a0ff 100%);
      background-size: 400% 400%;
      animation: gradientShift 15s ease infinite;
      color: #2d3748;
    }

    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .game-container {
      height: 100dvh;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    /* Header Section */
    .header {
      padding: 1rem 1.5rem;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.85));
      backdrop-filter: blur(10px);
      border-bottom: 3px solid #ff6b6b;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 10;
    }

    .game-title {
      font-size: 1.5rem;
      font-weight: 700;
      text-align: center;
      flex: 1;
      background: linear-gradient(135deg, #ff6b6b, #feca57);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
    }

    .score-display {
      background: linear-gradient(135deg, #ff6b6b, #feca57);
      color: white;
      padding: 0.6rem 1.2rem;
      border-radius: 2rem;
      font-weight: 700;
      min-width: 90px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
      border: 2px solid rgba(255, 255, 255, 0.8);
    }

    /* Game Status */
    .game-status {
      text-align: center;
      padding: 1rem;
      font-size: 1.2rem;
      font-weight: 600;
      min-height: 3rem;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.8));
      color: #2d3748;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      border-bottom: 2px solid #feca57;
    }

    /* Game Board */
    .game-board {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem 1rem;
      position: relative;
    }

    .pads-container {
      position: relative;
      width: min(80vw, 400px, calc(100dvh - 280px));
      height: min(80vw, 400px, calc(100dvh - 280px));
      max-width: 400px;
      max-height: 400px;
    }

    /* Game Pads */
    .game-pad {
      position: absolute;
      width: min(35vw, 120px);
      height: min(35vw, 120px);
      border-radius: 50%;
      border: 3px solid rgba(255, 255, 255, 0.8);
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
    }

    /* Diamond Layout */
    .pad-top {
      background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
      top: 0;
      left: 50%;
      transform: translateX(-50%);
    }

    .pad-right {
      background: linear-gradient(135deg, #4ecdc4, #44a3aa);
      top: 50%;
      right: 0;
      transform: translateY(-50%);
    }

    .pad-bottom {
      background: linear-gradient(135deg, #95e1d3, #3fc1c9);
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
    }

    .pad-left {
      background: linear-gradient(135deg, #f9ca24, #f0b90b);
      top: 50%;
      left: 0;
      transform: translateY(-50%);
    }

    /* Active State */
    .game-pad.active {
      transform: scale(1.15) !important;
      z-index: 100;
      box-shadow: 0 0 40px 15px currentColor, 0 0 80px 30px rgba(255, 255, 255, 0.3);
    }

    .pad-top.active {
      box-shadow: 0 0 40px 15px rgba(255, 107, 107, 0.8), 0 0 80px 30px rgba(255, 107, 107, 0.4);
    }

    .pad-right.active {
      box-shadow: 0 0 40px 15px rgba(78, 205, 196, 0.8), 0 0 80px 30px rgba(78, 205, 196, 0.4);
    }

    .pad-bottom.active {
      box-shadow: 0 0 40px 15px rgba(149, 225, 211, 0.8), 0 0 80px 30px rgba(149, 225, 211, 0.4);
    }

    .pad-left.active {
      box-shadow: 0 0 40px 15px rgba(249, 202, 36, 0.8), 0 0 80px 30px rgba(249, 202, 36, 0.4);
    }

    /* Pad Content */
    .pad-shape {
      font-size: 2.8rem;
      margin-bottom: 0.2rem;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
    }

    .pad-label {
      font-size: 1rem;
      font-weight: 700;
      letter-spacing: 1px;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
    }

    /* Control Section */
    .control-section {
      padding: 1.5rem;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.85));
      backdrop-filter: blur(10px);
      border-top: 3px solid #48dbfb;
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
    }

    .timer-bar {
      margin-bottom: 1rem;
      text-align: center;
    }

    .timer-display {
      width: 60px;
      height: 60px;
      margin: 0 auto 0.5rem;
      position: relative;
    }

    .timer-circle {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: conic-gradient(#ff6b6b 0deg, #feca57 90deg, #48dbfb 180deg, #ff9ff3 270deg, #ff6b6b 360deg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
      font-weight: 700;
      color: white;
      position: relative;
      border: 3px solid rgba(255, 255, 255, 0.8);
      box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
    }

    .timer-circle::before {
      content: '';
      position: absolute;
      inset: 6px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 50%;
    }

    .timer-circle span {
      position: relative;
      z-index: 1;
      color: #2d3748;
      font-weight: 800;
    }

    .timer-circle.urgent {
      background: conic-gradient(#ef4444 0deg, rgba(255, 255, 255, 0.2) 0deg);
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .start-button {
      width: 100%;
      padding: 1.2rem 2rem;
      font-size: 1.3rem;
      font-weight: 700;
      border: none;
      border-radius: 2rem;
      background: linear-gradient(135deg, #ff6b6b, #feca57);
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
      text-transform: uppercase;
      letter-spacing: 1px;
      border: 3px solid rgba(255, 255, 255, 0.8);
    }

    .start-button:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(255, 107, 107, 0.5);
      background: linear-gradient(135deg, #ff5252, #ffb142);
    }

    .start-button:active:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
    }

    .start-button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }

    /* Particle Effects */
    .particle {
      position: absolute;
      pointer-events: none;
      animation: particle-float 1.5s ease-out forwards;
      z-index: 200;
      font-size: 1.5rem;
    }

    @keyframes particle-float {
      0% {
        transform: translateY(0) scale(0) rotate(0deg);
        opacity: 1;
      }
      50% {
        transform: translateY(-20px) scale(1) rotate(180deg);
        opacity: 1;
      }
      100% {
        transform: translateY(-40px) scale(0) rotate(360deg);
        opacity: 0;
      }
    }

    /* Combo Display */
    .combo-display {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: linear-gradient(135deg, #ffd700, #ff6b6b);
      color: white;
      padding: 1rem 2rem;
      border-radius: 2rem;
      font-weight: 600;
      font-size: 1.5rem;
      box-shadow: 0 8px 32px rgba(255, 215, 0, 0.4);
      animation: combo-bounce 1s ease-out;
      z-index: 300;
    }

    @keyframes combo-bounce {
      0% {
        transform: translate(-50%, -50%) scale(0) rotate(-180deg);
        opacity: 0;
      }
      50% {
        transform: translate(-50%, -50%) scale(1.2) rotate(0deg);
      }
      100% {
        transform: translate(-50%, -50%) scale(1) rotate(0deg);
        opacity: 1;
      }
    }

    /* Responsive Design */
    @media (max-width: 400px) {
      .header {
        padding: 0.6rem 0.8rem;
      }

      .game-title {
        font-size: 1.2rem;
      }

      .score-display {
        padding: 0.5rem 0.8rem;
        font-size: 0.85rem;
        min-width: 65px;
      }

      .game-board {
        padding: 1rem 0.5rem;
      }

      .pad-shape {
        font-size: 2.2rem;
      }

      .pad-label {
        font-size: 0.8rem;
      }
    }

    @media (min-width: 768px) {
      .header {
        padding: 1.5rem 2rem;
      }

      .game-title {
        font-size: 2rem;
      }

      .pads-container {
        width: min(60vw, 500px);
        height: min(60vw, 500px);
      }

      .game-pad {
        width: min(25vw, 150px);
        height: min(25vw, 150px);
      }

      .pad-shape {
        font-size: 3rem;
      }

      .control-section {
        padding: 2rem;
      }
    }

    @media (orientation: landscape) and (max-height: 700px) {
      .header {
        padding: 0.75rem 1rem;
      }

      .game-title {
        font-size: 1.25rem;
      }

      .game-status {
        padding: 0.5rem;
        min-height: 2rem;
      }

      .game-board {
        padding: 1rem;
      }

      .control-section {
        padding: 1rem;
      }
    }

    /* Small height screens - ensure all UI fits in viewport */
    @media (max-height: 600px) {
      .header {
        padding: 0.5rem 1rem;
      }

      .game-title {
        font-size: 1.1rem;
      }

      .score-display {
        padding: 0.4rem 0.8rem;
        font-size: 0.85rem;
        min-width: 70px;
      }

      .game-status {
        padding: 0.5rem;
        min-height: 2rem;
        font-size: 1rem;
      }

      .game-board {
        padding: 0.5rem;
      }

      .pads-container {
        width: min(55vw, 45dvh);
        height: min(55vw, 45dvh);
      }

      .game-pad {
        width: min(25vw, 90px);
        height: min(25vw, 90px);
      }

      .pad-shape {
        font-size: 1.8rem;
      }

      .pad-label {
        font-size: 0.7rem;
      }

      .control-section {
        padding: 0.6rem;
      }

      .timer-display {
        width: 40px;
        height: 40px;
        margin-bottom: 0.3rem;
      }

      .timer-circle {
        font-size: 0.9rem;
      }

      .timer-circle::before {
        inset: 5px;
      }

      .start-button {
        padding: 0.6rem 1.2rem;
        font-size: 1rem;
      }
    }
  </style>
</head>
<body>
  <div class="game-container">
    <!-- Header -->
    <div class="header">
      <div class="score-display">Level <span id="level">1</span></div>
      <div class="game-title">‚ú® Follow the Lights! ‚ú®</div>
      <div class="score-display">Score <span id="score">0</span></div>
    </div>

    <!-- Game Status -->
    <div id="game-status" class="game-status">Press Start to Play!</div>

    <!-- Game Board -->
    <div class="game-board">
      <div class="pads-container" id="game-pads">
        <!-- Red Pad - Top -->
        <button id="pad-0" class="game-pad pad-top" data-color="red">
          <span class="pad-shape">‚óè</span>
          <span class="pad-label">RED</span>
        </button>

        <!-- Blue Pad - Right -->
        <button id="pad-1" class="game-pad pad-right" data-color="blue">
          <span class="pad-shape">‚ñ†</span>
          <span class="pad-label">BLUE</span>
        </button>

        <!-- Green Pad - Bottom -->
        <button id="pad-2" class="game-pad pad-bottom" data-color="green">
          <span class="pad-shape">‚ñ≤</span>
          <span class="pad-label">GREEN</span>
        </button>

        <!-- Yellow Pad - Left -->
        <button id="pad-3" class="game-pad pad-left" data-color="yellow">
          <span class="pad-shape">‚òÖ</span>
          <span class="pad-label">YELLOW</span>
        </button>
      </div>
    </div>

    <!-- Control Section -->
    <div class="control-section">
      <div class="timer-bar">
        <div class="timer-display">
          <div id="timer-circle" class="timer-circle">
            <span id="timer-text">10</span>
          </div>
        </div>
      </div>
      <button id="start-button" class="start-button">Start Game</button>
    </div>
  </div>

  <script>
    // Game Variables
    const gamePads = document.querySelectorAll('.game-pad');
    const startButton = document.getElementById('start-button');
    const gameStatusDisplay = document.getElementById('game-status');
    const scoreDisplay = document.getElementById('score');
    const levelDisplay = document.getElementById('level');
    const timerCircle = document.getElementById('timer-circle');
    const timerText = document.getElementById('timer-text');
    const gamePadsContainer = document.getElementById('game-pads');

    let gameSequence = [];
    let playerSequence = [];
    let score = 0;
    let level = 1;
    let combo = 0;
    let gameOn = false;
    let showingSequence = false;
    let canClick = false;
    let sequenceSpeed = 800;
    let turnTimer = null;
    let turnStartTime = null;

    const padColors = ['red', 'blue', 'green', 'yellow'];
    const encouragementMessages = [
      'Great!', 'Awesome!', 'Fantastic!', 'Perfect!',
      'Amazing!', 'Super!', 'Wonderful!', 'Excellent!'
    ];

    // Sound Setup
    const padSynth = new Tone.MembraneSynth({
      pitchDecay: 0.02,
      octaves: 1,
      envelope: {
        attack: 0.001,
        decay: 0.2,
        sustain: 0.01,
        release: 0.3,
      },
    }).toDestination();

    const gameOverSynth = new Tone.Synth({
      oscillator: { type: 'sine' },
      envelope: {
        attack: 0.01,
        decay: 0.4,
        sustain: 0.01,
        release: 0.8,
      },
    }).toDestination();

    const padFrequencies = [70, 90, 110, 130];

    // Helper Functions
    function createParticles(padIndex) {
      const pad = gamePads[padIndex];
      const rect = pad.getBoundingClientRect();
      const containerRect = gamePadsContainer.getBoundingClientRect();
      const colors = ['#ff6b6b', '#4ecdc4', '#95e1d3', '#f9ca24'];
      const emojis = ['‚ú®', '‚≠ê', 'üí´', 'üåü'];

      for (let i = 0; i < 8; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.textContent = emojis[Math.floor(Math.random() * emojis.length)];
        particle.style.left = `${rect.left - containerRect.left + rect.width / 2 - 15 + (Math.random() - 0.5) * 60}px`;
        particle.style.top = `${rect.top - containerRect.top + rect.height / 2 - 15 + (Math.random() - 0.5) * 60}px`;
        particle.style.color = colors[padIndex];
        particle.style.fontSize = `${16 + Math.random() * 8}px`;

        gamePadsContainer.appendChild(particle);
        setTimeout(() => particle.remove(), 1500);
      }
    }

    function startTurnTimer(duration = 10) {
      turnStartTime = Date.now();
      const durationMs = duration * 1000;

      timerCircle.classList.remove('urgent');
      timerText.textContent = duration;

      turnTimer = setInterval(() => {
        const elapsed = Date.now() - turnStartTime;
        const remaining = Math.max(0, durationMs - elapsed);
        const secondsLeft = Math.ceil(remaining / 1000);

        timerText.textContent = secondsLeft;

        // Update circular progress
        const progress = (remaining / durationMs) * 360;
        const color = remaining < durationMs * 0.3 ? '#ef4444' :
                     remaining < durationMs * 0.6 ? '#f59e0b' : '#10b981';
        timerCircle.style.background = `conic-gradient(${color} ${progress}deg, rgba(255, 255, 255, 0.2) ${progress}deg)`;

        if (remaining < durationMs * 0.3) {
          timerCircle.classList.add('urgent');
        }

        if (remaining <= 0) {
          clearInterval(turnTimer);
          if (gameOn) {
            gameOver("Time's up! ‚è∞");
          }
        }
      }, 100);
    }

    function stopTurnTimer() {
      if (turnTimer) {
        clearInterval(turnTimer);
        turnTimer = null;
      }
      timerCircle.classList.remove('urgent');
      timerText.textContent = '10';
      timerCircle.style.background = 'conic-gradient(#10b981 0deg, rgba(255, 255, 255, 0.2) 0deg)';
    }

    function showCombo() {
      // Combo display removed to eliminate distraction
      // Combo is still tracked internally for game mechanics
    }

    function updateScore() {
      scoreDisplay.textContent = score;
    }

    function updateLevel() {
      level = Math.floor(score / 3) + 1;
      levelDisplay.textContent = level;
    }

    // Game Logic
    function startGame() {
      Tone.start();

      gameSequence = [];
      playerSequence = [];
      score = 0;
      level = 1;
      combo = 0;
      updateScore();
      updateLevel();
      gameOn = true;
      showingSequence = false;
      canClick = false;
      sequenceSpeed = 800;
      gameStatusDisplay.textContent = 'Get Ready!';
      startButton.disabled = true;

      addNextToSequence();
      setTimeout(playSequence, 1000);
    }

    function addNextToSequence() {
      const randomPadIndex = Math.floor(Math.random() * gamePads.length);
      gameSequence.push(randomPadIndex);
    }

    function playSequence() {
      showingSequence = true;
      canClick = false;
      stopTurnTimer();
      gameStatusDisplay.textContent = 'Watch carefully...';
      playerSequence = [];

      let i = 0;
      const interval = setInterval(() => {
        if (i < gameSequence.length) {
          const padIndex = gameSequence[i];
          flashPad(padIndex);
          playTone(padIndex);
          i++;
        } else {
          clearInterval(interval);
          showingSequence = false;
          canClick = true;
          gameStatusDisplay.textContent = 'Your turn!';
          startTurnTimer(Math.max(5, 15 - Math.floor(score / 3)));
        }
      }, sequenceSpeed);
    }

    function flashPad(padIndex) {
      const pad = gamePads[padIndex];
      pad.classList.add('active');

      setTimeout(() => {
        pad.classList.remove('active');
      }, sequenceSpeed / 2);
    }

    function playTone(padIndex) {
      padSynth.triggerAttackRelease(padFrequencies[padIndex], '8n');
    }

    function handlePadClick(event) {
      if (!gameOn || showingSequence || !canClick) return;

      const clickedPad = event.target.closest('.game-pad');
      if (!clickedPad) return;

      const clickedPadIndex = Array.from(gamePads).indexOf(clickedPad);
      playerSequence.push(clickedPadIndex);

      flashPad(clickedPadIndex);
      playTone(clickedPadIndex);

      if (playerSequence[playerSequence.length - 1] !== gameSequence[playerSequence.length - 1]) {
        combo = 0;
        gameOver();
        return;
      }

      combo++;
      if (combo > 1) {
        showCombo();
      } else {
        const randomMessage = encouragementMessages[Math.floor(Math.random() * encouragementMessages.length)];
        gameStatusDisplay.textContent = randomMessage;
      }

      if (playerSequence.length === gameSequence.length) {
        stopTurnTimer();
        setTimeout(nextRound, 1000);
      }
    }

    function nextRound() {
      score++;
      updateScore();
      updateLevel();
      createParticles(gameSequence[gameSequence.length - 1]);
      gameStatusDisplay.textContent = 'Great job! Ready for next?';

      sequenceSpeed = Math.max(200, sequenceSpeed - 50);
      addNextToSequence();
      setTimeout(playSequence, 1500);
    }

    function gameOver(message = null) {
      gameOn = false;
      canClick = false;
      stopTurnTimer();

      const finalMessage = message || `Game Over! You reached level ${level}.`;
      gameStatusDisplay.textContent = finalMessage;
      startButton.disabled = false;

      gameOverSynth.triggerAttackRelease(40, '1s');
    }

    // Event Listeners
    startButton.addEventListener('click', startGame);

    gamePads.forEach((pad) => {
      pad.addEventListener('click', handlePadClick);
      pad.addEventListener('touchstart', (e) => {
        e.preventDefault();
        handlePadClick(e);
      });
    });

    // Initialize
    updateScore();
    updateLevel();
  </script>

  <!-- KidsGames PWA Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker
          .register('/KidsGames/sw.js')
          .then((registration) => {
            console.log('[PWA] Service Worker registered for free game');
          })
          .catch((error) => {
            console.log('[PWA] Service Worker registration failed:', error);
          });
      });
    }
  </script>
</body>
</html>